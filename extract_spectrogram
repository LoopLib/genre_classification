import librosa
import librosa.display
import numpy as np
import matplotlib.pyplot as plt
import os
import cv2

def extract_spectrogram(audio_path, save_dir=None, img_size=(128, 128)):
    """
    Convert an audio file to a mel spectrogram and optionally save it as an image.
    
    Parameters:
    - audio_path: Path to the input audio file.
    - save_dir: Directory to save the spectrogram image (if None, returns array).
    - img_size: Resize dimensions for CNN input.
    
    Returns:
    - spectrogram image array if save_dir is None.
    """
    y, sr = librosa.load(audio_path, sr=None)  # Load audio file
    mel_spec = librosa.feature.melspectrogram(y=y, sr=sr, n_mels=128, fmax=8000)
    mel_spec_db = librosa.power_to_db(mel_spec, ref=np.max)  # Convert to dB scale
    
    # Resize spectrogram to uniform size
    mel_spec_db_resized = cv2.resize(mel_spec_db, img_size)

    if save_dir:
        os.makedirs(save_dir, exist_ok=True)
        filename = os.path.splitext(os.path.basename(audio_path))[0] + ".png"
        save_path = os.path.join(save_dir, filename)
        plt.imsave(save_path, mel_spec_db_resized, cmap='gray')  # Save as grayscale image
    else:
        return mel_spec_db_resized
